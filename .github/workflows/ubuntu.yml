name: Ubuntu

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  CTEST_OUTPUT_ON_FAILURE: 1
  CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
  CPM_SOURCE_CACHE: ${{ github.workspace }}/cpm_modules

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 2
      - uses: actions/cache@v4
        with:
          path: "**/cpm_modules"
          key: ${{ github.workflow }}-cpm-modules-${{ hashFiles('**/CMakeLists.txt', '**/*.cmake') }}
      - name: Install CMake 4.0
        run: |
          sudo apt-get remove --purge cmake -y
          sudo apt-get autoremove -y
        
          # Download and install CMake 4.0
          CMAKE_VERSION=4.1.1
          wget https://github.com/Kitware/CMake/releases/download/v${CMAKE_VERSION}/cmake-${CMAKE_VERSION}-linux-x86_64.sh
          chmod +x cmake-${CMAKE_VERSION}-linux-x86_64.sh
          sudo ./cmake-${CMAKE_VERSION}-linux-x86_64.sh --skip-license --prefix=/usr/local
        
          # Verify installation
          cmake --version
      - name: Install Clang 20
        run: |
          # Remove old libc++ packages (if they exist)
          sudo apt-get remove -y libc++-dev libc++abi-dev || true
          # Remove old alternatives if they exist
          sudo update-alternatives --remove-all clang || true
          sudo update-alternatives --remove-all clang++ || true
          sudo update-alternatives --remove-all clang-format || true
          # Add LLVM repository
          wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add -
          sudo add-apt-repository "deb http://apt.llvm.org/$(lsb_release -cs)/ llvm-toolchain-$(lsb_release -cs)-20 main"
          sudo apt-get update
          # Install Clang 20 and related tools
          sudo apt-get install -y clang-20 clang++-20 libc++-20-dev libc++abi-20-dev libclang-rt-20-dev lld-20 clang-format-20
          dpkg -L libc++-20-dev
          # Create symbolic links to make Clang 20's libc++ the default
          sudo ln -sf /usr/lib/llvm-20/lib/libc++.so /usr/lib/x86_64-linux-gnu/libc++.so
          sudo ln -sf /usr/lib/llvm-20/lib/libc++.so.1 /usr/lib/x86_64-linux-gnu/libc++.so.1
          sudo ln -sf /usr/lib/llvm-20/lib/libc++abi.so /usr/lib/x86_64-linux-gnu/libc++abi.so
          sudo ln -sf /usr/lib/llvm-20/lib/libc++abi.so.1 /usr/lib/x86_64-linux-gnu/libc++abi.so.1
          # Create symbolic links for headers
          # sudo rm -rf /usr/include/c++/v1 || true
          # sudo ln -sf /usr/lib/llvm-20/include/c++/v1 /usr/include/c++/v1
          # Set Clang 20 as default with high priority
          sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-20 1000
          sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-20 1000
          sudo update-alternatives --set clang /usr/bin/clang-20
          sudo update-alternatives --set clang++ /usr/bin/clang++-20
          sudo update-alternatives --install /usr/bin/clang-format clang-format /usr/bin/clang-format-20 100
          # Verify the versions
          echo "Clang version:"
          clang --version
          echo "Clang++ version:"
          clang++ --version
          echo "/usr/lib/llvm-20/bin" >> $GITHUB_PATH
          echo "CPPFLAGS='-I/usr/lib/llvm-20/include/c++/v1 -I/usr/lib/llvm-20/include'" >> $GITHUB_ENV
          echo "LDFLAGS='-L/usr/lib/llvm-20/lib -L/usr/lib/llvm-20/lib/x86_64-unknown-linux-gnu -Wl,-rpath,/usr/lib/llvm-20/lib'" >> $GITHUB_ENV
          echo "ls /usr/lib/llvm-20"
          ls /usr/lib/llvm-20
          echo "ls /usr/lib/llvm-20/include"
          ls /usr/lib/llvm-20/include
          echo "ls /usr/lib/llvm-20/include/c++"
          ls /usr/lib/llvm-20/include/c++
          echo "ls /usr/lib/llvm-20/include/c++/v1"
          ls /usr/lib/llvm-20/include/c++/v1
          # Update ldconfig cache
          echo "/usr/lib/llvm-20/lib" | sudo tee /etc/ld.so.conf.d/llvm-20.conf
          sudo ldconfig

      - name: install cmake-format
        run: |
          sudo apt install python3-pip
          pip install cmake-format

      - run: git submodule update --init --recursive
      - name: no-san
        run: make clang-no-san
      - name: san
        run: make clang-san
      - name: test-format
        run: cmake --build build-clang/no-san --target check-format
