name: Ubuntu

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  CTEST_OUTPUT_ON_FAILURE: 1
  CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
  CPM_SOURCE_CACHE: ${{ github.workspace }}/cpm_modules

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 2
      - uses: actions/cache@v4
        with:
          path: "**/cpm_modules"
          key: ${{ github.workflow }}-cpm-modules-${{ hashFiles('**/CMakeLists.txt', '**/*.cmake') }}
      - name: Install CMake 4.0
        run: |
          sudo apt-get remove --purge cmake -y
          sudo apt-get autoremove -y
        
          # Download and install CMake 4.0
          CMAKE_VERSION=4.0.0
          wget https://github.com/Kitware/CMake/releases/download/v${CMAKE_VERSION}/cmake-${CMAKE_VERSION}-linux-x86_64.sh
          chmod +x cmake-${CMAKE_VERSION}-linux-x86_64.sh
          sudo ./cmake-${CMAKE_VERSION}-linux-x86_64.sh --skip-license --prefix=/usr/local
        
          # Verify installation
          cmake --version
      - name: Install Clang 21
        run: |
          # Add LLVM repository
          wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add -
          sudo add-apt-repository "deb http://apt.llvm.org/$(lsb_release -cs)/ llvm-toolchain-$(lsb_release -cs)-21 main"
          sudo apt-get update
        
          # Install Clang 21 and related tools
          sudo apt-get install -y clang-21 clang++-21 libc++-21-dev libc++abi-21-dev libclang-rt-21-dev lld-21
        
          # Remove old alternatives if they exist
          sudo update-alternatives --remove-all clang || true
          sudo update-alternatives --remove-all clang++ || true
        
          # Set Clang 21 as default with high priority
          sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-21 1000
          sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-21 1000
          sudo update-alternatives --set clang /usr/bin/clang-21
          sudo update-alternatives --set clang++ /usr/bin/clang++-21
        
          # Verify the versions
          echo "Clang version:"
          clang --version
          echo "Clang++ version:"
          clang++ --version
          echo "Which clang++:"
          which clang++
          ls -la /usr/bin/clang++
          echo "/usr/lib/llvm-21/bin" >> $GITHUB_PATH
          echo "CPPFLAGS=-I/usr/lib/llvm-21/include/c++/v1 -I/usr/lib/llvm-21/include" >> $GITHUB_ENV
          echo "LDFLAGS=-L/usr/lib/llvm-21/lib -L/usr/lib/llvm-21/lib/x86_64-unknown-linux-gnu -Wl,-rpath,/usr/lib/llvm-21/lib" >> $GITHUB_ENV

      - name: install boost
        run: sudo apt install libboost-all-dev libjemalloc
      - run: git submodule update --init --recursive
      - name: no-san
        run: make clang-no-san
      - name: san
        run: make clang-san
      - name: collect code coverage
        run: bash <(curl -s https://codecov.io/bash) || echo "Codecov did not collect coverage reports"
