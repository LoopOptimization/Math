name: Windows

on:
  push:
    branches:
      - master
      - main
  pull_request:
    branches:
      - master
      - main

env:
  CTEST_OUTPUT_ON_FAILURE: 1
  CPM_SOURCE_CACHE: ${{ github.workspace }}/cpm_modules

jobs:
  build:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 2
      - uses: actions/cache@v4
        with:
          path: "**/cpm_modules"
          key: ${{ github.workflow }}-cpm-modules-${{ hashFiles('**/CMakeLists.txt', '**/*.cmake') }}

      # Install CMake 4.1.1
      - name: Install CMake 4.1.1
        shell: powershell
        run: |
          $CMAKE_VERSION = "4.1.1"
          $url = "https://github.com/Kitware/CMake/releases/download/v$CMAKE_VERSION/cmake-$CMAKE_VERSION-windows-x86_64.msi"
          $output = "cmake-installer.msi"
          Write-Host "Downloading CMake $CMAKE_VERSION..."
          Invoke-WebRequest -Uri $url -OutFile $output
          Write-Host "Installing CMake..."
          Start-Process msiexec.exe -ArgumentList "/i", $output, "/quiet", "/norestart" -Wait
          $env:Path = "C:\Program Files\CMake\bin;$env:Path"
          Write-Host "CMake installed:"
          & "C:\Program Files\CMake\bin\cmake.exe" --version
  
      # Install LLVM/Clang 21
      - name: Install Clang 21
        shell: powershell
        run: |
          $LLVM_VERSION = "21.1.5"
          $url = "https://github.com/llvm/llvm-project/releases/download/llvmorg-$LLVM_VERSION/LLVM-$LLVM_VERSION-win64.exe"
          $output = "LLVM-installer.exe"
          Write-Host "Downloading LLVM/Clang $LLVM_VERSION..."
          Invoke-WebRequest -Uri $url -OutFile $output
          Write-Host "Installing LLVM/Clang..."
          Start-Process -FilePath $output -ArgumentList "/S" -Wait
          $env:Path = "C:\Program Files\LLVM\bin;$env:Path"
          Write-Host "Clang installed:"
          & "C:\Program Files\LLVM\bin\clang.exe" --version

      # Install Boost (precompiled)
      - name: Install Boost (precompiled)
        shell: powershell
        run: |
          $BOOST_VERSION = "1.87.0"
          $BOOST_VERSION_UNDERSCORE = $BOOST_VERSION -replace '\.', '_'
          $url = "https://boostorg.jfrog.io/artifactory/main/release/$BOOST_VERSION/source/boost_$BOOST_VERSION_UNDERSCORE.zip"
          $output = "boost.zip"
          Write-Host "Downloading Boost $BOOST_VERSION..."
          Invoke-WebRequest -Uri $url -OutFile $output
          Write-Host "Extracting Boost..."
          Expand-Archive -Path $output -DestinationPath C:\
          Rename-Item "C:\boost_$BOOST_VERSION_UNDERSCORE" "C:\boost"
          Write-Host "Boost extracted to C:\boost"

      # Add to PATH
      - name: Update PATH
        shell: powershell
        run: |
          $env:Path = "C:\Program Files\CMake\bin;C:\Program Files\LLVM\bin;$env:Path"
          echo "PATH=$env:Path" >> $env:GITHUB_ENV
          echo "BOOST_ROOT=C:\boost" >> $env:GITHUB_ENV

      - name: Verify installations
        shell: powershell
        run: |
          Write-Host "CMake version:"
          cmake --version
          Write-Host "`nClang version:"
          clang --version
          Write-Host "`nBoost location:"
          Test-Path "C:\boost\boost" | Write-Host
      - name: build no-san
        run: make no-san
